// Takt - Transportation Planning Database Schema
// Week structure: Sunday (day1) to Saturday (day7)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["tracing"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTHENTICATION & USERS ============

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String? // Bcrypt hashed password
  firstName           String
  lastName            String
  mobileNumber        String?
  avatarUrl           String? // Cloudinary URL
  role                UserRole
  currentOrgId        String? // Current organization context
  onboardingCompleted Boolean   @default(false) // Track if user completed onboarding
  emailVerified       Boolean   @default(false) // Track if email is verified via OTP
  emailVerifiedAt     DateTime? // When email was verified
  isActive            Boolean   @default(true)
  lastActivityAt      DateTime? // Last time user was active (for admin tracking)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  sessions                Session[]
  otpCodes                OTPCode[]
  auditLogs               AuditLog[]
  notifications           Notification[]
  passwordResetTokens     PasswordResetToken[]
  demandForecasts         DemandForecast[]
  supplyCommitments       SupplyCommitment[]
  organizationMemberships OrganizationMember[]
  managedClients          UserManagedClient[]

  @@index([email])
  @@index([role])
  @@index([currentOrgId])
  @@index([onboardingCompleted])
  @@index([lastActivityAt])
}

enum UserRole {
  DEMAND_PLANNER
  SUPPLY_PLANNER
  ADMIN
}

model UserManagedClient {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  partyId   String // Client (Party with role CUSTOMER)
  createdAt DateTime @default(now())

  @@unique([userId, partyId])
  @@index([userId])
  @@index([partyId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model OTPCode {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String // 6-digit code (hashed)
  purpose   OTPPurpose
  expiresAt DateTime
  usedAt    DateTime?
  attempts  Int        @default(0)
  createdAt DateTime   @default(now())

  @@index([userId, purpose])
  @@index([expiresAt])
}

enum OTPPurpose {
  EMAIL_VERIFICATION
  LOGIN
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Invitation {
  id             String    @id @default(cuid())
  email          String
  token          String    @unique
  organizationId String
  role           OrgRole // OWNER, ADMIN, MEMBER
  functionalRole UserRole // DEMAND_PLANNER, SUPPLY_PLANNER, ADMIN
  invitedBy      String // userId who sent the invite
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([organizationId])
  @@index([expiresAt])
  @@index([acceptedAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String // e.g., "demand_forecast.create", "supply.update"
  entityType String // e.g., "DemandForecast", "SupplyCommitment"
  entityId   String?
  metadata   Json? // Additional context (old/new values, etc.)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([action])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  entityId  String? // ID of related entity (forecast, commitment, etc.)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  DEMAND_CREATED
  SUPPLY_UPDATED
  SUPPLY_CREATED
}

// ============ ORGANIZATIONS & MULTI-TENANCY ============

model Organization {
  id                 String             @id @default(cuid())
  name               String // "Trella", "MEPCO", etc.
  slug               String             @unique // URL-friendly: "trella", "mepco"
  country            String?            @default("SA") // Country code (e.g., "SA", "EG", "AE")
  subscriptionTier   SubscriptionTier   @default(STARTER) // Subscription plan
  subscriptionStatus SubscriptionStatus @default(FREE_TRIAL) // Subscription status
  trialEndsAt        DateTime? // When free trial ends
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Platform Admin: Organization Suspension
  status          OrgStatus @default(ACTIVE) // ACTIVE or SUSPENDED
  suspendedAt     DateTime?
  suspendedReason String? // Reason for suspension
  suspendedBy     String? // Platform admin user ID

  // Stripe Integration
  stripeCustomerId            String?       @unique // Stripe customer ID
  stripeSubscriptionId        String?       @unique // Current Stripe subscription ID
  stripePriceId               String? // Current Stripe price ID
  currentBillingCycle         BillingCycle? // MONTHLY or ANNUAL
  subscriptionCurrentPeriodEnd DateTime? // When current billing period ends
  subscriptionCancelAtPeriodEnd Boolean @default(false) // True if downgrade/cancellation scheduled

  // Billing overrides (for platform admin)
  priceOverride Int? // Override price in cents (null = use standard pricing)
  seatLimit     Int? // Max users allowed (null = unlimited)

  // Relations
  domains           OrganizationDomain[]
  members           OrganizationMember[]
  settings          OrganizationSettings?
  parties           Party[]
  locations         Location[]
  resourceTypes     ResourceType[]
  demandCategories  DemandCategory[]
  planningWeeks     PlanningWeek[]
  demandForecasts   DemandForecast[]
  supplyCommitments SupplyCommitment[]
  subscriptionEvents SubscriptionEvent[]
  activityEvents    ActivityEvent[]

  @@index([slug])
  @@index([isActive])
  @@index([country])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
}

enum SubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  FREE_TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum SubscriptionEventType {
  CREATED
  UPGRADED
  DOWNGRADED
  RENEWED
  CANCELLED
  PAYMENT_FAILED
  REACTIVATED
  TRIAL_CONVERTED
}

model SubscriptionEvent {
  id              String                @id @default(cuid())
  organizationId  String
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  eventType       SubscriptionEventType
  fromTier        SubscriptionTier?
  toTier          SubscriptionTier?
  fromBillingCycle BillingCycle?
  toBillingCycle   BillingCycle?
  stripeEventId   String?               @unique
  amount          Int? // Amount in cents
  metadata        Json? // Additional event data
  triggeredBy     String? // userId who initiated (null for automated events)
  createdAt       DateTime              @default(now())

  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
}

model OrganizationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Custom labels for UI (defaults to trucking terminology)
  locationLabel           String @default("City") // "City" / "Warehouse" / "Factory" / "Store"
  locationLabelPlural     String @default("Cities")
  partyLabel              String @default("Partner") // "Client" / "Customer" / "Supplier" / "Vendor"
  partyLabelPlural        String @default("Partners")
  resourceTypeLabel       String @default("Truck Type") // "Truck Type" / "Product" / "Material" / "Machine Type"
  resourceTypeLabelPlural String @default("Truck Types")
  demandLabel             String @default("Demand")
  demandLabelPlural       String @default("Demand Forecasts")
  supplyLabel             String @default("Supply")
  supplyLabelPlural       String @default("Supply Commitments")

  // Demand category configuration
  demandCategoryLabel         String  @default("Category")
  demandCategoryLabelPlural   String  @default("Categories")
  demandCategoryEnabled       Boolean @default(false) // Disabled by default (opt-in)
  demandCategoryRequired      Boolean @default(false) // Each org decides if required

  // Planning configuration
  planningCycle PlanningCycle @default(DAILY) // DAILY, WEEKLY, MONTHLY
  weekStartDay  WeekStartDay  @default(SUNDAY) // SUNDAY, MONDAY, SATURDAY

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanningCycle {
  DAILY
  WEEKLY
  MONTHLY
}

enum WeekStartDay {
  SUNDAY
  MONDAY
  SATURDAY
}

model OrganizationDomain {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  domain            String       @unique // "trella.app", "mepco.com"
  isVerified        Boolean      @default(false)
  isPrimary         Boolean      @default(false) // One primary domain per org
  verificationToken String?      @unique // Token for DNS TXT record verification
  verifiedAt        DateTime? // When domain was verified
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([organizationId, domain])
  @@index([organizationId])
  @@index([domain])
  @@index([verificationToken])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           OrgRole // OWNER, ADMIN, MEMBER
  functionalRole UserRole // DEMAND_PLANNER, SUPPLY_PLANNER, ADMIN
  joinedAt       DateTime     @default(now())
  invitedBy      String? // userId who invited

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model PublicEmailDomain {
  id        String   @id @default(cuid())
  domain    String   @unique // "gmail.com", "outlook.com", "yahoo.com", etc.
  createdAt DateTime @default(now())

  @@index([domain])
}

// ============ MASTER DATA REPOSITORIES ============

// Party: Generic entity for Client, Supplier, Carrier, Customer, Vendor, etc.
model Party {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name             String // Organization name
  uniqueIdentifier String?      @unique // Auto-generated unique ID (e.g., "cli_abc123xyz")
  pointOfContact   String? // Main contact person name
  email            String? // Contact email address
  phoneNumber      String? // Contact phone number
  partyRole        PartyRole // CUSTOMER, SUPPLIER, CARRIER, etc.

  // Supplier-specific fields
  capacity         Int? // Total capacity (e.g., number of trucks)
  capacityType     String? // Type of capacity (e.g., "Curtainside Truck", "Flatbed", etc.)

  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  demandForecasts   DemandForecast[]
  supplyCommitments SupplyCommitment[]

  @@unique([organizationId, name, partyRole])
  @@index([organizationId])
  @@index([name])
  @@index([partyRole])
  @@index([isActive])
  @@index([uniqueIdentifier])
}

enum PartyRole {
  CUSTOMER // Client/Shipper (demand side)
  SUPPLIER // Carrier/Fleet Partner (supply side)
  CARRIER // 3PL/Logistics provider
  VENDOR // Material/product supplier
  MANUFACTURER // Production partner
  DISTRIBUTOR // Distribution partner
}

// Location: Generic entity for City, Warehouse, Factory, Store, Plant, etc.
model Location {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  code           String? // Short code for display
  nameAr         String? // Arabic name (optional, for localization)
  locationType   LocationType? // Optional categorization
  region         String? // Geographic/logical grouping
  metadata       Json? // Flexible additional data (coordinates, capacity, etc.)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  pickupForecasts  DemandForecast[] @relation("PickupLocation")
  dropoffForecasts DemandForecast[] @relation("DropoffLocation")

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([name])
  @@index([locationType])
  @@index([region])
  @@index([isActive])
}

enum LocationType {
  CITY
  WAREHOUSE
  FACTORY
  STORE
  PLANT
  DISTRIBUTION_CENTER
  PORT
  TERMINAL
}

// ResourceType: Generic entity for Truck Type, Product, Material, Machine Type, SKU, etc.
model ResourceType {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // e.g., "Curtainside", "Product A", "Raw Material X"
  code           String? // SKU, part number, etc.
  category       String? // Optional categorization
  metadata       Json? // Flexible additional data (specs, dimensions, etc.)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  demandForecastResourceTypes DemandForecastResourceType[]
  supplyCommitments           SupplyCommitment[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([name])
  @@index([category])
  @@index([isActive])
}

// DemandCategory: Optional categorization for demand forecasts (e.g., Vertical, Type, Class)
model DemandCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // e.g., "Domestic", "Ports", "Express", "Standard"
  code           String? // Optional short code for display
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  demandForecasts DemandForecast[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([name])
  @@index([isActive])
}

// ============ PLANNING ============

model PlanningWeek {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  weekStart      DateTime // Sunday of the week
  weekEnd        DateTime // Saturday of the week
  year           Int
  weekNumber     Int
  isCurrent      Boolean      @default(false)
  isLocked       Boolean      @default(false) // Prevent edits after week passes
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  demandForecasts   DemandForecast[]
  supplyCommitments SupplyCommitment[]

  @@unique([organizationId, year, weekNumber])
  @@index([organizationId])
  @@index([weekStart])
  @@index([isCurrent])
}

enum BusinessType {
  REGULAR // Consistent, long-term demand expected for 3+ months
  ADHOC   // Short-term, inconsistent demand for 1-2 weeks
}

model DemandForecast {
  id String @id @default(cuid())

  // Organization context
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Planning context
  planningWeekId String
  planningWeek   PlanningWeek @relation(fields: [planningWeekId], references: [id])

  // Party & Route (generic for any industry)
  partyId           String
  party             Party    @relation(fields: [partyId], references: [id])
  pickupLocationId  String
  pickupLocation    Location @relation("PickupLocation", fields: [pickupLocationId], references: [id])
  dropoffLocationId String
  dropoffLocation   Location @relation("DropoffLocation", fields: [dropoffLocationId], references: [id])
  routeKey          String // Auto-generated: "PICKUP->DROPOFF" (replaces citym)

  // Classification
  demandCategoryId String? // Optional: Organization-defined category (e.g., Domestic/Ports, Express/Standard)
  demandCategory   DemandCategory? @relation(fields: [demandCategoryId], references: [id])
  businessType     BusinessType    @default(REGULAR) // Regular (consistent, long-term) vs Adhoc (short-term, inconsistent)

  // Resource types (many-to-many: a forecast can be fulfilled by any of these types)
  resourceTypes    DemandForecastResourceType[]

  // Daily quantity forecasts (Sunday to Saturday) - for weekly planning
  day1Qty  Int @default(0) // Sunday
  day2Qty  Int @default(0) // Monday
  day3Qty  Int @default(0) // Tuesday
  day4Qty  Int @default(0) // Wednesday
  day5Qty  Int @default(0) // Thursday
  day6Qty  Int @default(0) // Friday
  day7Qty  Int @default(0) // Saturday

  // Weekly quantity forecasts (Week 1-5 of month) - for monthly planning
  week1Qty Int @default(0) // Week 1
  week2Qty Int @default(0) // Week 2
  week3Qty Int @default(0) // Week 3
  week4Qty Int @default(0) // Week 4
  week5Qty Int @default(0) // Week 5 (some months have 5 weeks)

  totalQty Int @default(0) // Computed sum (either sum of days or weeks depending on planning cycle)

  // Metadata
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([organizationId, planningWeekId, partyId, pickupLocationId, dropoffLocationId, demandCategoryId])
  @@index([organizationId])
  @@index([routeKey])
  @@index([planningWeekId])
  @@index([demandCategoryId])
  @@index([partyId])
  @@index([pickupLocationId])
  @@index([dropoffLocationId])
  @@index([createdById])
  @@index([planningWeekId, partyId])
  @@index([planningWeekId, routeKey])
}

// Junction table for DemandForecast to ResourceType many-to-many relationship
model DemandForecastResourceType {
  id               String         @id @default(cuid())
  demandForecastId String
  demandForecast   DemandForecast @relation(fields: [demandForecastId], references: [id], onDelete: Cascade)
  resourceTypeId   String
  resourceType     ResourceType   @relation(fields: [resourceTypeId], references: [id], onDelete: Cascade)
  createdAt        DateTime       @default(now())

  @@unique([demandForecastId, resourceTypeId])
  @@index([demandForecastId])
  @@index([resourceTypeId])
}

model SupplyCommitment {
  id String @id @default(cuid())

  // Organization context
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Planning context
  planningWeekId String
  planningWeek   PlanningWeek @relation(fields: [planningWeekId], references: [id])

  // Supply party info (generic for any industry)
  partyId        String
  party          Party         @relation(fields: [partyId], references: [id])
  routeKey       String // Route this commitment is for
  resourceTypeId String?
  resourceType   ResourceType? @relation(fields: [resourceTypeId], references: [id])

  // Daily committed supply/capacity (Sunday to Saturday) - for weekly planning
  day1Committed  Int @default(0) // Sunday
  day2Committed  Int @default(0) // Monday
  day3Committed  Int @default(0) // Tuesday
  day4Committed  Int @default(0) // Wednesday
  day5Committed  Int @default(0) // Thursday
  day6Committed  Int @default(0) // Friday
  day7Committed  Int @default(0) // Saturday

  // Weekly committed supply/capacity (Week 1-5 of month) - for monthly planning
  week1Committed Int @default(0) // Week 1
  week2Committed Int @default(0) // Week 2
  week3Committed Int @default(0) // Week 3
  week4Committed Int @default(0) // Week 4
  week5Committed Int @default(0) // Week 5

  totalCommitted Int @default(0) // Computed sum (either sum of days or weeks depending on planning cycle)

  // Metadata
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([organizationId, planningWeekId, partyId, routeKey, resourceTypeId])
  @@index([organizationId])
  @@index([routeKey])
  @@index([planningWeekId])
  @@index([partyId])
  @@index([resourceTypeId])
  @@index([createdById])
}

// ============ CONTACT FORM ============

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  position  String
  number    String
  email     String
  company   String
  country   String
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

// ============ REDASH DATA INTEGRATION ============

model RedashSync {
  id             String         @id @default(cuid())
  endpoint       RedashEndpoint @unique
  lastSyncAt     DateTime?
  lastSyncStatus SyncStatus
  recordsCount   Int            @default(0)
  errorMessage   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

enum RedashEndpoint {
  ACTUAL_SHIPPER_REQUESTS
  FLEET_PARTNER_COMPLETION
}

enum SyncStatus {
  SUCCESS
  FAILED
  IN_PROGRESS
}

model ActualShipperRequest {
  id             String   @id @default(cuid())
  externalId     String   @unique // ID from Redash
  shipperName    String? // Original shipper name from Redash
  citym          String
  requestDate    DateTime
  truckType      String?
  loadsRequested Int
  loadsFulfilled Int      @default(0)
  syncedAt       DateTime @default(now())

  @@index([citym])
  @@index([requestDate])
  @@index([shipperName])
}

model FleetPartnerCompletion {
  id             String   @id @default(cuid())
  externalId     String   @unique // ID from Redash
  supplierName   String? // Original supplier name from Redash
  citym          String
  completionDate DateTime
  truckType      String?
  loadsCompleted Int
  syncedAt       DateTime @default(now())

  @@index([citym])
  @@index([completionDate])
  @@index([supplierName])
}

// ============ PLATFORM ADMIN ============

// Platform Admins: Users who can access cross-org superadmin dashboard
model PlatformAdmin {
  id        String   @id @default(cuid())
  userId    String   @unique
  email     String   @unique // Redundant but useful for quick lookups
  role      PlatformAdminRole @default(ADMIN)
  createdAt DateTime @default(now())
  createdBy String? // userId who granted admin access
  revokedAt DateTime? // If access was revoked
  revokedBy String? // userId who revoked access

  @@index([userId])
  @@index([email])
  @@index([role])
}

enum PlatformAdminRole {
  ADMIN // Standard platform admin
  SUPER_ADMIN // Full access (future: can manage other admins)
}

// Activity Events: Track key user actions across the platform
model ActivityEvent {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorUserId    String // User who performed the action
  actorEmail     String // Denormalized for reporting
  eventType      String // e.g., "user.login", "demand.create", "supply.update"
  entityType     String? // e.g., "DemandForecast", "SupplyCommitment", "User"
  entityId       String? // ID of affected entity
  metadata       Json? // Additional context (old/new values, etc.)
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([actorUserId])
  @@index([eventType])
  @@index([createdAt])
  @@index([organizationId, createdAt])
  @@index([actorUserId, createdAt])
}

// Admin Audit Log: Track all platform admin actions
model AdminAuditLog {
  id           String   @id @default(cuid())
  adminUserId  String // Platform admin who performed the action
  adminEmail   String // Denormalized for reporting
  actionType   String // e.g., "org.suspend", "org.unsuspend", "org.change_plan"
  targetType   String // "organization", "user", "subscription"
  targetId     String // ID of affected entity
  targetName   String? // Name for display (org name, user email, etc.)
  beforeState  Json? // State before action
  afterState   Json? // State after action
  reason       String? // Admin's reason/note for the action
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([adminUserId])
  @@index([actionType])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@index([adminUserId, createdAt])
}
